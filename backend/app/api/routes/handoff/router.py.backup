"""
Handoff API Router â€” Inter-agent task delegation endpoints.
FilosofÃ­a: No velocity, only precision ğŸ¢ğŸ’
DDD: API Interface layer - exposes application service.
Strict <200L per file.
"""
from fastapi import APIRouter, HTTPException
from app.infrastructure.supabase_service import get_supabase_service
from app.services.handoff_service import HandoffService
from .models import (
    HandoffCreateRequest,
    HandoffConfirmRequest,
    HandoffCompleteRequest,
    HandoffResponse,
    HandoffConfirmationResponse,
    HandoffCompletionResponse,
    HandoffListResponse
)
import logging

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/handoff", tags=["handoff"])


@router.post("/", response_model=HandoffResponse, status_code=201)
async def create_handoff(request: HandoffCreateRequest):
    """
    Creates structured handoff between agents.

    Protocol:
    1. NOVA â†’ ATLAS: Strategic content brief
    2. ATLAS â†’ RAFA: Content generation task
    3. SENTINEL â†’ NOVA: Security alerts
    4. REX â†’ ANCHOR: Churn intervention
    """
    try:
        supabase = get_supabase_service()
        handoff_service = HandoffService(supabase)

        handoff = handoff_service.create_handoff(
            from_agent=request.from_agent,
            to_agent=request.to_agent,
            task_type=request.task_type,
            payload=request.payload,
            priority=request.priority,
            deadline=request.deadline
        )

        logger.info(
            f"Handoff created: {handoff.task_id} | "
            f"{request.from_agent} â†’ {request.to_agent} | "
            f"type={request.task_type}"
        )

        return HandoffResponse(
            task_id=handoff.task_id,
            from_agent=handoff.from_agent,
            to_agent=handoff.to_agent,
            task_type=handoff.task_type,
            payload=handoff.payload,
            priority=handoff.priority.value,
            status=handoff.status.value,
            created_at=handoff.created_at,
            deadline=handoff.deadline
        )

    except ValueError as e:
        logger.error(f"Validation error creating handoff: {e}")
        raise HTTPException(400, str(e))
    except Exception as e:
        logger.error(f"Error creating handoff: {e}")
        raise HTTPException(500, f"Error creating handoff: {str(e)}")


@router.post("/{task_id}/confirm", response_model=HandoffConfirmationResponse)
async def confirm_handoff(task_id: str, request: HandoffConfirmRequest):
    """
    Agent confirms receipt of handoff.

    Transitions: PENDING â†’ IN_PROGRESS
    """
    try:
        supabase = get_supabase_service()
        handoff_service = HandoffService(supabase)

        confirmation = handoff_service.confirm_receipt(
            task_id=task_id,
            agent_code=request.agent_code
        )

        logger.info(f"Handoff {task_id} confirmed by {request.agent_code}")

        return HandoffConfirmationResponse(
            task_id=confirmation.task_id,
            confirmed_by=confirmation.confirmed_by,
            confirmed_at=confirmation.confirmed_at,
            status=confirmation.status.value
        )

    except ValueError as e:
        logger.error(f"Validation error confirming {task_id}: {e}")
        raise HTTPException(400, str(e))
    except Exception as e:
        logger.error(f"Error confirming handoff {task_id}: {e}")
        raise HTTPException(500, f"Error confirming handoff: {str(e)}")


@router.post("/{task_id}/complete", response_model=HandoffCompletionResponse)
async def complete_handoff(task_id: str, request: HandoffCompleteRequest):
    """
    Agent marks handoff as complete with result.

    Transitions: IN_PROGRESS â†’ COMPLETED
    """
    try:
        supabase = get_supabase_service()
        handoff_service = HandoffService(supabase)

        completion = handoff_service.complete_handoff(
            task_id=task_id,
            agent_code=request.agent_code,
            result=request.result
        )

        logger.info(
            f"Handoff {task_id} completed by {request.agent_code} | "
            f"result_keys={list(request.result.keys())}"
        )

        return HandoffCompletionResponse(
            task_id=completion.task_id,
            completed_by=completion.completed_by,
            completed_at=completion.completed_at,
            result=completion.result
        )

    except ValueError as e:
        logger.error(f"Validation error completing {task_id}: {e}")
        raise HTTPException(400, str(e))
    except Exception as e:
        logger.error(f"Error completing handoff {task_id}: {e}")
        raise HTTPException(500, f"Error completing handoff: {str(e)}")


@router.get("/pending/{agent_code}", response_model=HandoffListResponse)
async def get_pending_handoffs(agent_code: str):
    """
    Retrieves all pending handoffs for an agent.

    Use this endpoint for agents to check their task queue.
    """
    try:
        supabase = get_supabase_service()
        handoff_service = HandoffService(supabase)

        handoffs = handoff_service.get_pending_handoffs(agent_code)

        handoff_responses = [
            HandoffResponse(
                task_id=h.task_id,
                from_agent=h.from_agent,
                to_agent=h.to_agent,
                task_type=h.task_type,
                payload=h.payload,
                priority=h.priority.value,
                status=h.status.value,
                created_at=h.created_at,
                deadline=h.deadline
            )
            for h in handoffs
        ]

        logger.info(f"Retrieved {len(handoffs)} pending handoffs for {agent_code}")

        return HandoffListResponse(
            handoffs=handoff_responses,
            count=len(handoff_responses)
        )

    except Exception as e:
        logger.error(f"Error fetching pending handoffs for {agent_code}: {e}")
        raise HTTPException(500, f"Error fetching handoffs: {str(e)}")


@router.get("/{task_id}", response_model=HandoffResponse)
async def get_handoff(task_id: str):
    """
    Retrieves a specific handoff by task_id.
    """
    try:
        supabase = get_supabase_service()
        handoff_service = HandoffService(supabase)

        handoff = handoff_service._get_handoff(task_id)

        return HandoffResponse(
            task_id=handoff.task_id,
            from_agent=handoff.from_agent,
            to_agent=handoff.to_agent,
            task_type=handoff.task_type,
            payload=handoff.payload,
            priority=handoff.priority.value,
            status=handoff.status.value,
            created_at=handoff.created_at,
            deadline=handoff.deadline
        )

    except ValueError as e:
        logger.error(f"Handoff {task_id} not found: {e}")
        raise HTTPException(404, str(e))
    except Exception as e:
        logger.error(f"Error fetching handoff {task_id}: {e}")
        raise HTTPException(500, f"Error fetching handoff: {str(e)}")
